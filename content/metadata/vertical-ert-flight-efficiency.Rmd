---
title: Vertical en route flight efficiency
output: 
  html_document:
    mathjax: default
categories:
  - metadata
  - glossary
---

```{r, echo=FALSE, results='asis'}
res <- knitr::knit_child(
  here::here('static', 'css', 'table.css'),
  quiet = TRUE)
cat(res, sep = '\n')
```

## Contacts

```{r, echo=FALSE, results='asis'}
res <- knitr::knit_child(
  here::here('parts', 'contacts.Rmd'),
  quiet = TRUE)
cat(res, sep = '\n')
```

## Metadata update

```{r, echo=FALSE, results='asis'}
res <- knitr::knit_child(
  here::here('parts', 'metadata-update.Rmd'),
  quiet = TRUE)
cat(res, sep = '\n')
```

## Summary
Vertical en-route flight efficiency in the Single European Sky performance scheme is defined as “the percentage of the length of the actual trajectory flown within 1 000 ft below, or at any altitude above the planned flight level from the last filed flight plan, summed over all IFR flights within or traversing European airspace”.

Annex I, Sections 1 and 2, paragraph 2.2 (c) of 
[Commission Implementing Regulation (EU) 2024/3128][no3128_2024].

The calculation involves several steps:

1.	Determination of the ToC and ToD, which are the first point on the flight plan (FTFM) trajectory reaching the first RFL and the last point leaving the last RFL respectively
2.	The comparison of the CTFM and FTFM trajectories resulting in the combined FTFM/CTFM profile
3.	Identification of distances being flown WITHIN, ABOVE or BELOW the 1000 ft limit from the planned flight level (between ToC and ToD)
4.	Identification of distances in step 3 for each airspace being monitored

The VFE indicator will be the percentage of the sum of all (WITHIN+ABOVE) over the sum of (WITHIN+ABOVE+BELOW) for each airspace and the time span monitored.

Entry data: 

* FTFM and CTFM trajectories as generated by the NM system (from the so called ALL_FT_CPF_CPG files, same as the one used for the Horizontal Flight Efficiency (HFE) indicators KEP/KEA), including the point and airspace profiles.
* The Requested Flight Level (RFL) definition, as archived from the flight plans
* The area definitions: Area Control Centers (ACC), Countries, Functional Airspace Blocks (FAB), SES area, NM area

Output: 

* Distance flown WITHIN, BELOW or ABOVE the 1000 ft limit from the planned (FTFM) flight level, measured along the actual (CTFM) trajectory between the top of climb and the top of descent (en-route part of the trajectory), for each operated flight and each airspace in the area definitions.

## Methodology
This section presents the methodology used to calculate the indicator at both EU-wide and local levels.

Based on the flight plan and the environment data, the NM system is generating a 4D flight plan trajectory (a series of points defined by latitude, longitude, flight level and time over) called Filed Tactical Flight Model (FTFM) trajectory, corresponding to the last filed flight plan.
Once the flight is airborne, a Current Tactical Flight Model (CTFM) trajectory is created, which is constantly updated with airborne information received from ANSPs or Air Operators (e.g. correlated radar positions reports). After the flight has operated, the “final version” of the CTFM trajectory, also called the actual trajectory, is archived[^1]. 

### Step 1: determining the en-route portion of the flight
The scope of the VFE indicator is the en-route portion of the trajectory defined as the portion of the trajectory between Top of Climb (ToC) and Top of Descent (ToD).
ToC is defined as the first point of the flight plan (FTFM) trajectory where the flight level matches the first flight plan requested flight level (RFL). Symmetrically, the ToD is defined as the last point of the FTFM trajectory where the flight level matches the last RFL.

For the flight in the example below, the graph below shows the identified ToC and ToD.

<span style="color:red">N0442F340</span> MEROS DCT LAPIT DCT CHELY DCT LUMAS DCT <span style="color:red">MAXIR/N0450F360</span> UN853 IRMAR DCT KINES DCT VANAS DCT MOBLO DCT UBIMA DCT GILIR DCT PENDU DCT IXILU DCT <span style="color:red">EPL/N0430F320</span> DCT ROUSY DCT DIK N853 ARCKY T853 NVO T857 BIKMU BIKMU1A

The **RFL matching** does not include those points that are part of a continuous climb or descent portion of the trajectory. That is, the RFL is matched in **only one point**, and the FTFM FL of that point (FL 0) is different from both the previous (FL -1) and the subsequent point (FL +1) flight levels:

- **Climb:** FL -1 < FL 0 < FL +1  
- **Descent:** FL -1 > FL 0 > FL +1

For certain flights, a **ToC/ToD** cannot be found, even though they have an RFL defined in the flight plan. This can occur when the FTFM trajectory **does not reach the RFL** (e.g., the flight is too short).

In another specific case, although a ToC and ToD exist by definition, they **coincide in a single point** (i.e., *ToC = ToD*). In both situations, the **en-route portion is nil**.

![Vertical flight profile](/images/ert_vfe_prof.png)

### Step 2: comparison of the CTFM and FTFM trajectories
This step identifies **corresponding or equivalent points** from one model to another (*FTFM points on CTFM* and *CTFM points on FTFM*).
When a **2D point** (latitude/longitude) appears on both the **FTFM** and **CTFM** trajectories, it is considered a **common point** [^2]. 
For the points **between common points**, the equivalent is determined using **linear interpolation**, based on the ratio:

> Distance from the previous common point  
> divided by  
> Distance between the previous and subsequent common points

The result of this step is the **combined FTFM/CTFM profile**.

### Step 3: identification of distances being flown off planned (requested) flight level 
For the **en-route (ENR)** portion in the combined **FTFM/CTFM** profile, the actual CTFM (equivalent) flight level (**AFL**) is compared with the planned FTFM (equivalent) flight level (**PFL**), and three categories are defined as follows:

1.	**WITHIN**: PFL – 1000 ft < AFL < PFL + 1000 ft 
    
    → Flight is considered to be flying within 1000 ft of the planned flight level.

2.	**ABOVE**: AFL >= PFL + 1000 ft when the flight is considered as being flown at or above the +1000 ft deviation 
   
    → Flight is considered to be flown at or above the +1000 ft deviation.

3.	**BELOW**: AFL <= PFL - 1000 ft when the flight is considered as being flown at or below the -1000 ft deviation 
   
    → Flight is considered to be flown at or below the -1000 ft deviation.

Hereinafter:
- The uppercase terms **WITHIN**, **ABOVE**, and **BELOW** refer to these categories.
- The term **ENR** refers to the en-route portion of the combined FTFM/CTFM profile.

It follows that:  
**ENR = WITHIN + ABOVE + BELOW**

These categories can refer to:
- a segment of the trajectory,
- an entire flight,
- or a group of flights.

They can also refer to portions of flights **crossing an airspace** or **defined area** in the network.

> The **WITHIN** and **ABOVE** categories constitute the **scope of the Vertical Flight Efficiency (VFE)** indicator, as defined in *Annex I, Sections 1 and 2, paragraph 2.2(c)* of the **[Commission Implementing Regulation (EU) 2024/3128][no3128_2024]**.

####  Segment Definition
A segment in the combined **FTFM/CTFM** profile is defined between two consecutive points (**PT_1** and **PT_2**). These points can be:
- common to both FTFM and CTFM,
- on the FTFM trajectory (with an equivalent on CTFM), or
- on the CTFM trajectory (with an equivalent on FTFM).

For each segment:
- The segment’s category (**WITHIN**, **ABOVE**, or **BELOW**) is based on the **AFL-PFL difference** at its end points.
- If **both end points** fall in the same category, the **full segment distance** is allocated to that category.
- If a segment **crosses the +1000 ft or -1000 ft thresholds**, the distance is **proportionally distributed** between the relevant categories.

#### VFE Indicator Calculation
Given:

- `CTFM_SEG_ENR_DIST`: total length of the ENR portion of the actual CTFM trajectory
- `CTFM_SEG_ENR_DIST_WITHIN`: portion flown **within** ±1000 ft of PFL
- `CTFM_SEG_ENR_DIST_ABOVE`: portion flown **above** +1000 ft
- `CTFM_SEG_ENR_DIST_BELOW`: portion flown **below** -1000 ft

The **VFE indicator** is calculated as:

```{r, eval=FALSE}
VFE = (∑flight(s) (CTFM_SEG_ENR_DIST_WITHIN + CTFM_SEG_ENR_DIST_ABOVE)) / ∑flight(s) (CTFM_SEG_ENR_DIST)
```

Those distances are also calculated in a similar fashion along the FTFM trajectory (FTFM_SEG_ENR_DIST_WITHIN etc). 
They can be calculated for any group of flights or for the portion of those flights that sits within a certain airspace.

### Step 4: Identification of distances being flown off planned (requested) flight level in an airspace 
For each segment in the combined **FTFM/CTFM** profile, the **segment distances** are apportioned to the relevant **airspace(s)** based on:
- the segment's end points, and  
- the flight's entry and exit points into the subject airspaces.

#### Airspace allocation logic:
- A segment that lies **entirely within one airspace** will have its distances (**ENR**, **WITHIN**, **ABOVE**, **BELOW**) fully allocated to that airspace.
- If a segment **spans across multiple airspaces**, the distances are **distributed across those airspaces**, taking into account the **sequence of airspace entry and exit points** along the segment.  
  > Importantly, the distribution is **not proportional to distance**, as one portion of a segment may be **WITHIN**, while another may be **BELOW**.

#### VFE Indicator per Airspace
The **Vertical Flight Efficiency (VFE)** indicator for a specific airspace is calculated as:

```{r, eval=FALSE}
VFE = (∑flight(s),airspace (CTFM_SEG_ENR_DIST_WITHIN + CTFM_SEG_ENR_DIST_ABOVE)) / ∑flight(s),airspace (CTFM_SEG_ENR_DIST)
```

[^1]: See https://ansperformance.eu/definition/flight-models/ for more information on flight trajectory models
[^2]: When a 2D point is present more than once in the FTFM / CTFM trajectories, the common points are determined by the time order of their appearance, i.e. first appearance on FTFM trajectory is matched with the first one on CTFM trajectory, second with second and so on. Certain 2D points, although they are present on both FTFM and CTFM trajectories, are not considered common in certain cases like in a circular flight, when the same point is present on the outgoing leg of the FTFM trajectory but on the incoming leg of the CTFM trajectory 

[no3128_2024]: https://eur-lex.europa.eu/legal-content/EN/TXT/?uri=CELEX:32024R3128 "IR 3128/2024"